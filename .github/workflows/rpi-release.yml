name: Raspberry Pi Build

on:
  # Manual trigger from GitHub UI or API
  workflow_dispatch:
    inputs:
      upload_to_release:
        description: 'Upload to latest GitHub release'
        required: true
        default: 'false'
        type: boolean

  # Or trigger on version tags
  push:
    tags:
      - 'v*'

jobs:
  build-rpi:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version tags

      - name: Get version info
        id: version
        run: |
          VERSION=$(grep -oP 'VERSION \K[0-9]+\.[0-9]+\.[0-9]+' CMakeLists.txt)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build on ARM64 (emulated)
        uses: uraimo/run-on-arch-action@v2
        id: build
        with:
          arch: aarch64
          distro: bookworm

          # Cache the build environment
          githubToken: ${{ github.token }}

          # Mount the workspace
          dockerRunArgs: |
            --volume "${PWD}:/workspace"

          # Install dependencies and build
          install: |
            apt-get update
            apt-get install -y \
              build-essential \
              cmake \
              git \
              qt6-base-dev \
              qt6-declarative-dev \
              qt6-connectivity-dev \
              qt6-charts-dev \
              qt6-svg-dev \
              qt6-multimedia-dev \
              qt6-speech-dev \
              qt6-positioning-dev \
              qt6-websockets-dev \
              libxkbcommon-dev \
              libgl1-mesa-dev \
              libssl-dev \
              file

          run: |
            cd /workspace
            echo "=== Qt Version ==="
            qmake6 --version || true

            echo "=== Configuring ==="
            mkdir -p build/rpi
            cd build/rpi
            cmake ../.. -DCMAKE_BUILD_TYPE=Release

            echo "=== Building ==="
            make -j$(nproc)

            echo "=== Build complete ==="
            ls -la Decenza_DE1
            file Decenza_DE1

      - name: Package build
        run: |
          VERSION=${{ steps.version.outputs.version }}
          cd build/rpi

          # Create tarball with binary and dependencies info
          mkdir -p package/Decenza_DE1
          cp Decenza_DE1 package/Decenza_DE1/

          # Add a simple README
          cat > package/Decenza_DE1/README.txt << 'EOF'
          Decenza DE1 - Raspberry Pi Build

          Requirements:
          - Raspberry Pi 4/5 (64-bit OS)
          - Qt 6 runtime libraries (install with: sudo apt install qt6-base-dev qt6-declarative-dev qt6-connectivity-dev)

          Running:
          - With display: ./Decenza_DE1 -platform eglfs
          - Over VNC: ./Decenza_DE1 -platform vnc

          For BLE permissions:
            sudo setcap 'cap_net_admin+eip' ./Decenza_DE1

          See https://github.com/Kulitorum/Decenza/blob/main/RASPBERRY_PI.md for full instructions.
          EOF

          # Create tarball
          cd package
          tar -czvf ../Decenza_DE1_${VERSION}_rpi_arm64.tar.gz Decenza_DE1
          cd ..

          echo "=== Package created ==="
          ls -la *.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Decenza_DE1-RaspberryPi
          path: build/rpi/Decenza_DE1_*.tar.gz
          retention-days: 30

      - name: Upload to GitHub Release
        if: ${{ inputs.upload_to_release == 'true' || startsWith(github.ref, 'refs/tags/v') }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          TARBALL="build/rpi/Decenza_DE1_${VERSION}_rpi_arm64.tar.gz"

          # Find the release (by tag or latest)
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG="v${VERSION}"
          fi

          echo "Uploading to release: $TAG"
          gh release upload "$TAG" "$TARBALL" --clobber || echo "Release $TAG not found, skipping upload"
